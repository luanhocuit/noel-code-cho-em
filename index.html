<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Christmas - Final Clean</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000000;
            font-family: 'Segoe UI', sans-serif;
        }

        #canvas-container {
            width: 100%;
            height: 100vh;
            display: block;
        }

        #ui-layer {
            position: absolute;
            bottom: 30px;
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 100;
        }

        .guide { 
            color: rgba(255, 255, 255, 0.6); 
            font-size: 13px; 
            margin-bottom: 20px; 
            text-shadow: 0 2px 4px black;
        }

        button {
            pointer-events: auto;
            cursor: pointer;
            background: linear-gradient(to bottom, #D32F2F, #8B0000); 
            color: #FFF;
            border: 2px solid #FFD700;
            padding: 15px 50px;
            border-radius: 30px; 
            font-weight: 800;
            font-size: 16px;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.6);
        }

        #camera-preview {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 120px;
            height: 90px;
            border: 2px solid rgba(255,0,0,0.5);
            transform: scaleX(-1);
            opacity: 0.6;
            border-radius: 8px;
        }

        #copyright {
            position: absolute;
            bottom: 10px;
            right: 15px;
            color: rgba(255, 255, 255, 0.3);
            font-size: 12px;
            z-index: 100;
            pointer-events: none;
            font-style: italic;
        }
    </style>
</head>

<body>
<div id="ui-layer">
    <div class="guide">
        üñê Open: Explode &nbsp;|&nbsp; ü´∂ Heart: Love &nbsp;|&nbsp; ‚úä Fist: Tree
    </div>
    <button id="btnStart" onclick="startSystem()">START MAGIC</button>
</div>

<div id="copyright">¬© by vandiep</div>

<div id="canvas-container"></div>
<video class="input_video" style="display:none"></video>
<canvas id="camera-preview"></canvas>

<script>
/* =====================================================
   1. RESOURCE
===================================================== */
const MUSIC_URL = "./audio.mp3";
let bgMusic = new Audio(MUSIC_URL);
bgMusic.loop = true;
bgMusic.volume = 1.0;

/* =====================================================
   2. CONFIG
===================================================== */
const CONFIG = {
    explodeRadius: 65
};

let scene, camera, renderer;
let titleMesh, starMesh, loveMesh;

let state = 'TREE';
let handX = 0.5;
let handY = 0.5;

/* ‚ù§Ô∏è Anti flicker heart */
let heartStartTime = 0;
const HEART_HOLD_TIME = 400;

/* =====================================================
   3. INIT 3D
===================================================== */
function init3D() {
    const container = document.getElementById('canvas-container');

    scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x000000, 0.002);

    camera = new THREE.PerspectiveCamera(
        60,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
    );
    camera.position.z = 100;

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    container.appendChild(renderer.domElement);

    createDecorations();
    animate();
}

/* =====================================================
   4. DECORATION
===================================================== */
function createDecorations() {

    /* MERRY CHRISTMAS */
    const canvas = document.createElement('canvas');
    canvas.width = 1024;
    canvas.height = 256;
    const ctx = canvas.getContext('2d');

    ctx.font = 'bold italic 90px "Times New Roman"';
    ctx.fillStyle = '#FFD700';
    ctx.textAlign = 'center';
    ctx.shadowColor = "#FF0000";
    ctx.shadowBlur = 40;
    ctx.fillText("MERRY CHRISTMAS", 512, 130);

    const tex = new THREE.CanvasTexture(canvas);
    titleMesh = new THREE.Mesh(
        new THREE.PlaneGeometry(60, 15),
        new THREE.MeshBasicMaterial({
            map: tex,
            transparent: true,
            blending: THREE.AdditiveBlending
        })
    );
    titleMesh.position.set(0, 50, 0);
    scene.add(titleMesh);

    /* STAR */
    const starCanvas = document.createElement('canvas');
    starCanvas.width = 128;
    starCanvas.height = 128;
    const sCtx = starCanvas.getContext('2d');

    sCtx.fillStyle = "#FFFF00";
    sCtx.shadowColor = "#FFF";
    sCtx.shadowBlur = 20;
    sCtx.beginPath();

    const cx = 64, cy = 64, outer = 50, inner = 20;
    for (let i = 0; i < 5; i++) {
        sCtx.lineTo(
            cx + Math.cos((18 + i * 72) / 180 * Math.PI) * outer,
            cy - Math.sin((18 + i * 72) / 180 * Math.PI) * outer
        );
        sCtx.lineTo(
            cx + Math.cos((54 + i * 72) / 180 * Math.PI) * inner,
            cy - Math.sin((54 + i * 72) / 180 * Math.PI) * inner
        );
    }
    sCtx.closePath();
    sCtx.fill();

    const starTex = new THREE.CanvasTexture(starCanvas);
    starMesh = new THREE.Mesh(
        new THREE.PlaneGeometry(12, 12),
        new THREE.MeshBasicMaterial({
            map: starTex,
            transparent: true,
            blending: THREE.AdditiveBlending
        })
    );
    starMesh.position.set(0, 40, 0);
    scene.add(starMesh);

    /* I LOVE YOU */
    const loveCanvas = document.createElement('canvas');
    loveCanvas.width = 1024;
    loveCanvas.height = 256;
    const lCtx = loveCanvas.getContext('2d');

    lCtx.font = 'bold 120px "Segoe UI"';
    lCtx.fillStyle = '#FF69B4';
    lCtx.textAlign = 'center';
    lCtx.shadowColor = "#FF1493";
    lCtx.shadowBlur = 40;
    lCtx.fillText("I LOVE YOU ‚ù§Ô∏è", 512, 150);

    const loveTex = new THREE.CanvasTexture(loveCanvas);
    loveMesh = new THREE.Mesh(
        new THREE.PlaneGeometry(70, 18),
        new THREE.MeshBasicMaterial({
            map: loveTex,
            transparent: true,
            blending: THREE.AdditiveBlending
        })
    );
    loveMesh.visible = false;
    scene.add(loveMesh);
}

/* =====================================================
   5. ANIMATE
===================================================== */
function animate() {
    requestAnimationFrame(animate);

    const time = Date.now() * 0.001;

    /* Vu·ªët ƒëa h∆∞·ªõng nh∆∞ ƒëi·ªán tho·∫°i */
    const targetRotY = (handX - 0.5) * 4.0;
    const targetRotX = (handY - 0.5) * 2.5;

    scene.rotation.y += (targetRotY - scene.rotation.y) * 0.08;
    scene.rotation.x += (targetRotX - scene.rotation.x) * 0.08;

    if (state === 'TREE') {
        titleMesh.visible = true;
        starMesh.visible = true;
        loveMesh.visible = false;
        starMesh.rotation.z -= 0.02;
    }

    if (state === 'HEART') {
        titleMesh.visible = false;
        starMesh.visible = false;
        loveMesh.visible = true;
        const s = 1 + Math.abs(Math.sin(time * 3)) * 0.1;
        loveMesh.scale.set(s, s, 1);
    }

    renderer.render(scene, camera);
}

/* =====================================================
   6. START SYSTEM
===================================================== */
function startSystem() {
    document.getElementById('btnStart').style.display = 'none';
    bgMusic.play().catch(()=>{});
    init3D();

    const video = document.querySelector('.input_video');
    const canvas = document.getElementById('camera-preview');
    const ctx = canvas.getContext('2d');

    const hands = new Hands({
        locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });

    hands.setOptions({
        maxNumHands: 2,
        modelComplexity: 1,
        minDetectionConfidence: 0.6,
        minTrackingConfidence: 0.6
    });

    hands.onResults(results => {
        ctx.clearRect(0, 0, 120, 90);
        ctx.drawImage(results.image, 0, 0, 120, 90);

        /* HEART GESTURE */
        if (results.multiHandLandmarks.length === 2) {
            const h1 = results.multiHandLandmarks[0];
            const h2 = results.multiHandLandmarks[1];

            const distIndex = Math.hypot(h1[8].x - h2[8].x, h1[8].y - h2[8].y);
            const distThumb = Math.hypot(h1[4].x - h2[4].x, h1[4].y - h2[4].y);

            if (distIndex < 0.15 && distThumb < 0.15) {
                if (heartStartTime === 0) heartStartTime = Date.now();
                if (Date.now() - heartStartTime > HEART_HOLD_TIME) {
                    state = 'HEART';
                }
                return;
            }
        }

        heartStartTime = 0;

        if (results.multiHandLandmarks.length > 0) {
            const lm = results.multiHandLandmarks[0];
            handX = lm[9].x;
            handY = lm[9].y;

            const pinchDist = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
            state = pinchDist < 0.05 ? 'PHOTO' : 'TREE';
        } else {
            state = 'TREE';
        }
    });

    new Camera(video, {
        onFrame: async () => {
            await hands.send({ image: video });
        },
        width: 320,
        height: 240
    }).start();
}

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
